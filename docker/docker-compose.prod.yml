version: '3.8'

services:
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    volumes:
      - ..:/app
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    expose:
      - "8000"
    environment:
      - DEBUG=0
      - DJANGO_SETTINGS_MODULE=DjangoProject.settings_docker
      - SECRET_KEY=django-insecure-prod-simulation-key-12345
      - ALLOWED_HOSTS=*
    depends_on:
      - db
      - redis
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2'
          memory: 4G
    command: > 
      gunicorn DjangoProject.wsgi:application 
      --bind 0.0.0.0:8000 
      --workers 4 
      --threads 4 
      --worker-class 
      gthread 
      --worker-tmp-dir 
      /dev/shm 
      --backlog 
      2048

  nginx:
    image: nginx:1.25-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      - NGINX_ENTRYPOINT_QUIET_LOGS=1
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '2'
          memory: 2G
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
      - static_volume:/app/staticfiles:ro
      - media_volume:/app/media:ro
    depends_on:
      - web

  db:
    image: postgres:15
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=learnonline
      - POSTGRES_USER=learnonline_user
      - POSTGRES_PASSWORD=learnonline_password
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '4'
          memory: 8G
    command: >
      postgres 
      -c shared_buffers=2GB 
      -c effective_cache_size=6GB
      -c work_mem=64MB 
      -c max_connections=1000 
      -c fsync=off 
      -c synchronous_commit=off 
      -c full_page_writes=off
      -c checkpoint_timeout=30min

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data_prod:/data
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '1'
          memory: 1G

  redis_cache:
    image: redis:7-alpine
    volumes:
      - redis_cache_prod:/data
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '1'
          memory: 1G

volumes:
  postgres_data_prod:
  redis_data_prod:
  redis_cache_prod:
  static_volume:
  media_volume:
